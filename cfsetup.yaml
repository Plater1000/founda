base-image: &base-image docker-registry.cfdata.org/stash/plat/dockerfiles/debian-bullseye-rustlang/master:1.72.0-0-0

builddeps: &builddeps-common
  ? libclang-11-dev
  ? libelf-dev
  ? pkg-config

builddeps-macos: &builddeps-macos
  <<: *builddeps-common
  ? clang
  ? cmake
  ? g++
  ? gcc
  ? libssl-dev
  ? libxml2-dev
  ? patch
  ? xz-utils
  ? zlib1g-dev

bullseye:
  check-features:
    base_image: *base-image
    builddeps:
      <<: *builddeps-common
      ? cargo-hack
    post-cache:
      - . cf-cargo-configure.sh
      - sccache-pull oxy-bedrock && export RUSTC_WRAPPER=sccache
      - RUSTFLAGS="-D warnings" cargo hack check --feature-powerset --no-dev-deps --depth 3
      - sccache -s && sccache-push oxy-bedrock

  test:
    base_image: *base-image
    builddeps:
      <<: *builddeps-common
    post-cache:
      - . cf-cargo-configure.sh
      - sccache-pull oxy-bedrock && export RUSTC_WRAPPER=sccache
      - _RJEM_MALLOC_CONF=prof:true cargo nextest run --profile ci
      - sccache -s && sccache-push oxy-bedrock

  lint:
    base_image: *base-image
    builddeps:
      <<: *builddeps-common
    post-cache:
      - . cf-cargo-configure.sh
      - sccache-pull oxy-bedrock && export RUSTC_WRAPPER=sccache
      - ./scripts/lint.sh
      - sccache -s && sccache-push oxy-bedrock

  build-macos:
    base_image: *base-image
    builddeps:
      <<: *builddeps-macos
    post-cache:
      - . cf-cargo-configure.sh
      - ./scripts/macos-osxcross-setup.sh
      - ./scripts/macos-osxcross-build.sh

  publish:
    base_image: *base-image
    builddeps:
      <<: *builddeps-common
    post-cache:
      - cf-cargo-publish.sh
