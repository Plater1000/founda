builddeps: &builddeps-common
  ? rust
  ? sccache
  ? libclang-11-dev
  ? libssl-dev
  ? pkg-config
  ? openssh-client
  ? build-essential
  ? cmake
  ? unzip
  ? libelf-dev
  ? libsctp-dev
  ? cargo-to-teamcity
  ? cf-rust-tools

builddeps-macos: &builddeps-macos
  ? libclang-11-dev
  ? libssl-dev
  ? pkg-config
  ? openssh-client
  ? build-essential
  ? cmake
  ? unzip
  ? libelf-dev
  ? clang
  ? gcc
  ? g++
  ? zlib1g-dev
  ? libmpc-dev
  ? libmpfr-dev
  ? libgmp-dev
  ? patch
  ? libxml2-dev
  ? xz-utils
  ? cf-rust-tools

default-flavor: bullseye

everything: &everything
  check-features:
    builddeps:
      <<: *builddeps-common
      ? cargo-hack
    post-cache:
      - . cf-cargo-configure.sh
      - sccache-pull oxy-bedrock && export RUSTC_WRAPPER=sccache
      - RUSTFLAGS="-D warnings" cargo hack check --feature-powerset --no-dev-deps
      - sccache -s && sccache-push oxy-bedrock

  test:
    builddeps:
      <<: *builddeps-common
    post-cache:
      - . cf-cargo-configure.sh
      - sccache-pull oxy-bedrock && export RUSTC_WRAPPER=sccache
      - cargo test
      - sccache -s && sccache-push oxy-bedrock

  lint:
    builddeps:
      <<: *builddeps-common
      ? cargo-deny
    post-cache:
      - . cf-cargo-configure.sh
      - sccache-pull oxy-bedrock && export RUSTC_WRAPPER=sccache
      - ./scripts/lint.sh
      - sccache -s && sccache-push oxy-bedrock

  build-macos:
    builddeps:
      <<: *builddeps-macos
    post-cache:
      - . cf-cargo-configure.sh
      - ./scripts/macos-osxcross-setup.sh
      - ./scripts/macos-osxcross-build.sh

  publish:
    builddeps:
      <<: *builddeps-common
    post-cache:
      - cf-cargo-publish.sh

bullseye: *everything
